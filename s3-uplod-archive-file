#!/bin/bash
# ============================================================
# EFS Backup Script
# Archives /vol/app/common/current, uploads to S3, and deletes local archive
# ============================================================

set -e

SOURCE_DIR="/vol/app/common/current"
ARCHIVE_DIR="/vol/app/common/archive"
BACKUP_BUCKET="prd-efs-backup"
DATE=$(date +%Y%m%d)   # üëà Only date (no time)
ARCHIVE_NAME="current_${DATE}.tar.gz"
ARCHIVE_PATH="${ARCHIVE_DIR}/${ARCHIVE_NAME}"

# Create archive directory if not exists
mkdir -p "$ARCHIVE_DIR"

echo "üß© Creating archive from ${SOURCE_DIR}..."
tar -czf "$ARCHIVE_PATH" -C "$SOURCE_DIR" .

if [[ $? -eq 0 ]]; then
    echo "‚úÖ Archive created: ${ARCHIVE_PATH}"
else
    echo "‚ùå Failed to create archive"
    exit 1
fi

# Upload to S3
echo "‚¨ÜÔ∏è Uploading archive to S3 bucket: ${BACKUP_BUCKET}"
aws s3 cp "$ARCHIVE_PATH" "s3://${BACKUP_BUCKET}/prd-cta-app/${DATE}/" --storage-class STANDARD_IA

if [[ $? -eq 0 ]]; then
    echo "‚úÖ Successfully uploaded ${ARCHIVE_NAME} to S3"
    echo "üßπ Deleting local archive: ${ARCHIVE_PATH}"
    rm -f "$ARCHIVE_PATH"
else
    echo "‚ùå Upload failed, archive not deleted"
    exit 1
fi

echo "üéØ Backup completed successfully at $(date)"
